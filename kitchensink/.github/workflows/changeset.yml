name: Changesets

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Permissions needed for creating PRs and releases
permissions:
  contents: write
  pull-requests: write

# Prevent parallel execution when multiple PRs are merged quickly
# This avoids race conditions in git operations and PR creation
concurrency:
  group: changeset-${{ github.ref }}
  cancel-in-progress: false # Queue runs instead of canceling

jobs:
  version-prs:
    name: Create Per-Project PRs
    runs-on: ubuntu-latest
    # Only run on main branch pushes
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for git operations

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Install go-changeset
        run: go install github.com/jakoblorz/go-changesets/cmd/changeset@latest

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Analyze changeset relationships
        id: tree
        run: |
          # Capture tree BEFORE versioning (versioning deletes changesets)
          changeset tree --filter open-changesets --format json > /tmp/tree.json

          echo "Changeset relationships:"
          changeset tree --filter open-changesets

          echo ""
          echo "Tree data saved to /tmp/tree.json"

      - name: Create per-project PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          changeset each --filter open-changesets -- sh -c '
            set -e

            BRANCH="changeset-release/$PROJECT"

            echo "ðŸ“¦ Creating PR for $PROJECT..."

            git checkout -b "$BRANCH" 2>/dev/null || git checkout "$BRANCH"

            # Run version - this deletes changesets
            changeset version \
              --owner ${{ github.repository_owner }} \
              --repo ${{ github.event.repository.name }}

            if git diff --quiet && git diff --cached --quiet; then
              echo "âš ï¸  No changes to commit for $PROJECT"
              git checkout main
              exit 0
            fi

            VERSION=$(cat "$PROJECT_PATH/version.txt" 2>/dev/null || echo "unknown")

            git add .
            git commit -m "chore: version $PROJECT to $VERSION"
            git push -u origin "$BRANCH" --force

            # Use the new gh pr open command - handles PR creation and updates
            # CHANGELOG_PREVIEW is already set by changeset each
            changeset gh pr open \
              --owner ${{ github.repository_owner }} \
              --repo ${{ github.event.repository.name }}

            git checkout main
            git reset --hard origin/main
            git clean -fd

            echo "âœ… PR created/updated for $PROJECT"
          '

      - name: Link related PRs
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if tree.json exists
          if [ ! -f /tmp/tree.json ]; then
            echo "No tree data, skipping PR linking"
            exit 0
          fi

          # Use the new gh pr link command - links related PRs using tree data
          changeset gh pr link \
            --owner ${{ github.repository_owner }} \
            --repo ${{ github.event.repository.name }} \
            --tree-file /tmp/tree.json

          echo "âœ… Related PRs linked"

      - name: Close obsolete release PRs
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for obsolete release PRs..."

          # For each project with no changesets (unchanged)
          changeset each --filter unchanged -- sh -c '
            # Use the new gh pr close command - closes obsolete PRs and deletes branches
            changeset gh pr close \
              --owner ${{ github.repository_owner }} \
              --repo ${{ github.event.repository.name }} \
              --project "$PROJECT"
          ' || true

          echo "âœ… Obsolete PR cleanup complete"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release PRs Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Per-project release PRs have been created for all projects with changesets." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View pull requests: https://github.com/${{ github.repository }}/pulls" >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish Releases
    runs-on: ubuntu-latest
    # Only run on main branch pushes
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Wait for version-prs to complete to avoid race conditions
    needs: version-prs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for git tags

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Install go-changeset
        run: go install github.com/jakoblorz/go-changesets/cmd/changeset@latest

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for outdated versions
        id: check_publish
        run: |
          # Check if any projects have version.txt > git tag
          # Use a test command to check if filter returns any projects
          if changeset each --filter outdated-versions -- echo "found" 2>/dev/null | grep -q "found"; then
            echo "has_outdated=true" >> $GITHUB_OUTPUT
            echo "Outdated projects found"
          else
            echo "has_outdated=false" >> $GITHUB_OUTPUT
            echo "No projects to publish"
          fi

      - name: Publish releases
        if: steps.check_publish.outputs.has_outdated == 'true'
        run: |
          # Publish all projects where version.txt > git tag
          changeset each --filter outdated-versions -- \
            changeset publish \
              --owner ${{ github.repository_owner }} \
              --repo ${{ github.event.repository.name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check_publish.outputs.has_outdated == 'true'
        run: |
          echo "## ðŸŽ‰ Releases Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GitHub releases have been created for all updated projects." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View releases: https://github.com/${{ github.repository }}/releases" >> $GITHUB_STEP_SUMMARY
