name: Changesets

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Permissions needed for creating PRs and releases
permissions:
  contents: write
  pull-requests: write

# Prevent parallel execution when multiple PRs are merged quickly
# This avoids race conditions in git operations and PR creation
concurrency:
  group: changeset-${{ github.ref }}
  cancel-in-progress: false # Queue runs instead of canceling

jobs:
  version-prs:
    name: Create Per-Project PRs
    runs-on: ubuntu-latest
    # Only run on main branch pushes
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for git operations

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Install go-changeset
        run: go install github.com/jakoblorz/go-changesets/cmd/changeset@latest

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Analyze changeset relationships
        id: tree
        run: |
          # Capture tree BEFORE versioning (versioning deletes changesets)
          changeset tree --filter open-changesets --format json > /tmp/tree.json

          echo "Changeset relationships:"
          changeset tree --filter open-changesets

          echo ""
          echo "Tree data saved to /tmp/tree.json"

      - name: Create per-project PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Initialize PR mapping file
          > /tmp/pr-mapping.txt

          changeset each --filter open-changesets -- sh -c '
            set -e
            
            BRANCH="changeset-release/$PROJECT"
            
            echo "üì¶ Creating PR for $PROJECT..."
            
            git checkout -b "$BRANCH" 2>/dev/null || git checkout "$BRANCH"
            
            changeset version \
              --owner ${{ github.repository_owner }} \
              --repo ${{ github.event.repository.name }}
            
            if git diff --quiet && git diff --cached --quiet; then
              echo "‚ö†Ô∏è  No changes to commit for $PROJECT"
              git checkout main
              exit 0
            fi
            
            VERSION=$(jq -r ".version // empty" "$PROJECT_PATH/package.json" 2>/dev/null \
              || cat "$PROJECT_PATH/version.txt" 2>/dev/null \
              || echo "unknown")

            git add .
            git commit -m "chore: version $PROJECT to $VERSION"
            git push -u origin "$BRANCH" --force
            
            PR_BODY="This PR was automatically generated for **$PROJECT**.

          ## üìã Changes

          $CHANGELOG_PREVIEW

          <!-- RELATED_PRS_PLACEHOLDER -->

          ## üì¶ What happens when you merge?
          - Version bumped to **$VERSION**
          - Changelog updated
          - Changesets consumed
          - Publish workflow creates GitHub release: \`$PROJECT@v$VERSION\`"
            
            # Create PR and capture URL
            PR_URL=$(gh pr create \
              --title "üöÄ Release $PROJECT v$VERSION" \
              --body "$PR_BODY" \
              --head "$BRANCH" \
              --base main \
              --label "release" \
              --label "automated" 2>&1 | grep "https://github.com" || echo "")
            
            # Save PR number for linking step
            if [ -n "$PR_URL" ]; then
              PR_NUM=$(echo "$PR_URL" | grep -o "[0-9]*$")
              echo "$PROJECT=$PR_NUM" >> /tmp/pr-mapping.txt
              echo "Created PR #$PR_NUM for $PROJECT"
            else
              # PR might already exist, try to update it and get PR number
              gh pr edit "$BRANCH" \
                --title "üöÄ Release $PROJECT v$VERSION" \
                --body "$PR_BODY" || true
              
              # Get PR number for existing PR
              EXISTING_PR=$(gh pr list --head "$BRANCH" --json number -q '.[0].number' 2>/dev/null || echo "")
              if [ -n "$EXISTING_PR" ]; then
                echo "$PROJECT=$EXISTING_PR" >> /tmp/pr-mapping.txt
                echo "Updated existing PR #$EXISTING_PR for $PROJECT"
              fi
            fi
            
            git checkout main
            git reset --hard origin/main
            git clean -fd
            
            echo "‚úÖ PR created/updated for $PROJECT"
          '

      - name: Link related PRs
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if tree.json exists
          if [ ! -f /tmp/tree.json ]; then
            echo "No tree data, skipping PR linking"
            exit 0
          fi

          # Check if jq is available
          if ! command -v jq &> /dev/null; then
            echo "jq not installed, skipping PR linking"
            exit 0
          fi

          # Check if any PR mappings exist
          if [ ! -f /tmp/pr-mapping.txt ] || [ ! -s /tmp/pr-mapping.txt ]; then
            echo "No PRs created, skipping linking"
            exit 0
          fi

          echo "Linking related PRs..."

          # Process each group
          jq -c '.groups[]' /tmp/tree.json | while read -r group; do
            COMMIT_SHORT=$(echo "$group" | jq -r '.commitShort')
            COMMIT_MSG=$(echo "$group" | jq -r '.message // "Unknown"')
            
            # Get all projects in this group
            PROJECTS=$(echo "$group" | jq -r '.projects[].name' | sort -u)
            PROJECT_COUNT=$(echo "$PROJECTS" | wc -l | tr -d " ")
            
            # Skip if only one project (no relationships to show)
            if [ "$PROJECT_COUNT" -le 1 ]; then
              continue
            fi
            
            echo "Processing group $COMMIT_SHORT ($PROJECT_COUNT projects)"
            
            # Build PR list for this group
            PR_LIST=""
            for proj in $PROJECTS; do
              PR_NUM=$(grep "^$proj=" /tmp/pr-mapping.txt | cut -d= -f2 | tr -d " ")
              if [ -n "$PR_NUM" ]; then
                PR_LIST="$PR_LIST
          - #$PR_NUM Release $proj"
              fi
            done
            
            # Update each PR in the group with links to related PRs
            for proj in $PROJECTS; do
              PR_NUM=$(grep "^$proj=" /tmp/pr-mapping.txt | cut -d= -f2 | tr -d " ")
              
              if [ -z "$PR_NUM" ]; then
                continue
              fi
              
              # Build related section
              RELATED_SECTION="

          ## üîó Related Release PRs

          This release is part of a coordinated change from commit [\`$COMMIT_SHORT\`]:
          $PR_LIST

          **üí° Tip:** These changes were made together. Consider reviewing and merging all related PRs together for consistency."
              
              # Get current PR body
              CURRENT_BODY=$(gh pr view $PR_NUM --json body -q .body 2>/dev/null || echo "")
              
              if [ -z "$CURRENT_BODY" ]; then
                echo "  ‚ö†Ô∏è  Could not get body for PR #$PR_NUM"
                continue
              fi
              
              # Replace placeholder with actual links
              NEW_BODY=$(echo "$CURRENT_BODY" | awk -v section="$RELATED_SECTION" \
                '{gsub(/<!-- RELATED_PRS_PLACEHOLDER -->/, section); print}')
              
              # Update PR
              echo "$NEW_BODY" | gh pr edit $PR_NUM --body-file - 2>/dev/null || {
                echo "  ‚ö†Ô∏è  Could not update PR #$PR_NUM"
                continue
              }
              
              echo "  ‚úÖ Updated PR #$PR_NUM ($proj) with related PR links"
            done
          done

          echo "‚úÖ Related PRs linked"

      - name: Close obsolete release PRs
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for obsolete release PRs..."

          # For each project with no changesets (unchanged)
          changeset each --filter unchanged -- sh -c '
            BRANCH="changeset-release/$PROJECT"
            
            # Check if PR exists for this branch
            PR_NUM=$(gh pr list --head "$BRANCH" --state open --json number -q ".[0].number" 2>/dev/null || echo "")
            
            if [ -n "$PR_NUM" ]; then
              echo "Closing obsolete PR #$PR_NUM for $PROJECT (no changesets remaining)"
              
              CLOSE_MSG="‚úÖ This release PR is no longer needed (no changesets remaining for $PROJECT). If new changesets are added, a new PR will be created automatically."
              
              gh pr close $PR_NUM --comment "$CLOSE_MSG" || true
              
              # Delete the branch
              git push origin --delete "$BRANCH" 2>/dev/null || true
            fi
          ' || true

          echo "‚úÖ Obsolete PR cleanup complete"

      - name: Summary
        run: |
          echo "## üéâ Release PRs Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Per-project release PRs have been created for all projects with changesets." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View pull requests: https://github.com/${{ github.repository }}/pulls" >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish Releases
    runs-on: ubuntu-latest
    # Only run on main branch pushes
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Wait for version-prs to complete to avoid race conditions
    needs: version-prs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for git tags

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"

      - name: Install go-changeset
        run: go install github.com/jakoblorz/go-changesets/cmd/changeset@latest

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for outdated versions
        id: check_publish
        run: |
          # Check if any projects have version.txt > git tag
          # Use a test command to check if filter returns any projects
          if changeset each --filter outdated-versions -- echo "found" 2>/dev/null | grep -q "found"; then
            echo "has_outdated=true" >> $GITHUB_OUTPUT
            echo "Outdated projects found"
          else
            echo "has_outdated=false" >> $GITHUB_OUTPUT
            echo "No projects to publish"
          fi

      - name: Publish releases
        if: steps.check_publish.outputs.has_outdated == 'true'
        run: |
          # Publish all projects where version.txt > git tag
          changeset each --filter outdated-versions -- \
            changeset publish \
              --owner ${{ github.repository_owner }} \
              --repo ${{ github.event.repository.name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check_publish.outputs.has_outdated == 'true'
        run: |
          echo "## üéâ Releases Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GitHub releases have been created for all updated projects." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View releases: https://github.com/${{ github.repository }}/releases" >> $GITHUB_STEP_SUMMARY
